<div class="chantier-detail-container">
  <div class="breadcrumb">
    <span class="breadcrumb-part" [routerLink]="['/accueil/chantiers']">Chantiers</span>
    <span class="breadcrumb-part clickable" [routerLink]="['/accueil/chantiers', chantierId]">{{ chantierTitre }}</span>
    <span class="breadcrumb-part">Marchandises</span>
  </div>

  <div class="content">
    <div class="top-controls">
   <div class="month-selector">
  <select (change)="onSituationChange($any($event.target).value)">
    <option value="">Filter par situation</option>
    <ng-container *ngIf="situations?.length; else noSituations">
      <option *ngFor="let situation of situations" [value]="situation.id">
        {{ situation.nomSituation }}
      </option>
    </ng-container>
    <ng-template #noSituations>
      <option value="" disabled>Aucune situation trouvée</option>
    </ng-template>
  </select>
</div>


    <div class="add-button-container">
      <button class="add-btn" (click)="openAddCommandeModal()">+ Ajouter une commande</button>
    </div>

    </div>


    <div class="table-container">
      <table class="commande-table">
        <thead>
          <tr>
            <th>Fournisseur</th>
            <th>Situation</th>
            <th>Prix HT (€)</th>
            <th>TVA (%)</th>
            <th>TTC (€)</th>
            <th>Date Commande</th>
            <th>Description</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let commande of commandesToDisplay">
            <td>{{ commande.nomFournisseur }}</td>
           <td>{{ getSituationNom(commande.situationId) }}</td>
            
            <td>{{ commande.prixHT | number:'1.2-2' }}</td>
            <td>{{ commande.tva }}</td>
            <td>{{ commande.prixTTC | number:'1.2-2' }}</td>
            <td>{{ commande.dateCommande | date:'dd/MM/yyyy' }}</td>
            <td class="description-cell">
              <div class="description-wrapper">
                <span class="description-text">{{ commande.description }}</span>
                <i class="fas" [ngClass]="{'fa-chevron-down': !(expandedTooltip === commande.id), 'fa-chevron-up': expandedTooltip === commande.id}" [class.tooltip-arrow]="true" (click)="commande.id ? toggleTooltip(commande.id, $event) : null"></i>
              </div>
              <div class="tooltip" *ngIf="commande.id && expandedTooltip === commande.id" (click)="$event.stopPropagation()">
                <p>{{ commande.description }}</p>
              
              </div>
            </td>
            <td class="action-cell">
              <button class="edit-btn" (click)="openModifyCommandeModal(commande)">
                <i class="fas fa-edit"></i>
              </button>
              <button class="delete-btn" (click)="openDeleteConfirmModal(commande.id)">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="commandesToDisplay.length === 0">
            <td colspan="7">Aucune commande trouvée.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="total-ttc-wrapper">
      <div class="total-ttc">
        <span>Total TTC: {{ totalTTC | number:'1.2-2' }} €</span>
      </div>
    </div>

    <div *ngIf="showDeleteConfirmModal" class="modal-overlay confirm-modal">
      <div class="modal-container">
        <div class="modal-body">
          <div class="confirm-content">
            <div class="warning-icon">⚠️</div>
            <p>Êtes-vous sûr de vouloir supprimer cette commande ?</p>
            <div class="confirm-actions">
              <button class="cancel-btn" (click)="cancelDelete()">Annuler</button>
              <button class="confirm-btn" (click)="confirmDelete()">Confirmer</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="isSuccessDelete" class="modal-overlay success-modal">
      <div class="modal-container">
        <div class="modal-body">
          <div class="success-content">
            <div class="check-circle">
              <span class="check-icon">✔</span>
            </div>
            <p>La commande a été supprimée avec succès.</p>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="isSuccessAdd" class="modal-overlay success-modal">
      <div class="modal-container">
        <div class="modal-body">
          <div class="success-content">
            <div class="check-circle">
              <span class="check-icon">✔</span>
            </div>
            <p>La commande a été ajoutée avec succès.</p>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="isSuccessModified" class="modal-overlay success-modal">
      <div class="modal-container">
        <div class="modal-body">
          <div class="success-content">
            <div class="check-circle">
              <span class="check-icon">✔</span>
            </div>
            <p>La commande a été modifiée avec succès.</p>
          </div>
        </div>
      </div>
    </div>

    <app-add-commande
      *ngIf="showAddCommandeModal"
      [chantierId]="chantierId!"
      [situations]="situations"
      [isLoadingSituations]="isLoadingSituations"
      [errorMessage]="addCommandeError"
      (close)="closeAddCommandeModal()"
      (addCommande)="addCommande($event)"
      (formValid)="onFormValid($event)">
    </app-add-commande>

    <app-modify-commande
      *ngIf="showModifyCommandeModal"
      [commande]="selectedCommande!"
      [situations]="situations"
      (close)="closeModifyCommandeModal()"
      (updateCommande)="updateCommande($event)">
    </app-modify-commande>

 

    <div class="pagination" *ngIf="commandes.length > 0">
      <span>Page</span>
      <button
        class="page-arrow"
        [disabled]="currentPage === 1"
        (click)="goToPage(currentPage - 1)"
      >
        <
      </button>
      <span class="page-number current">{{ currentPage }}</span>
      <button
        class="page-arrow"
        [disabled]="currentPage === totalPages"
        (click)="goToPage(currentPage + 1)"
      >
        >
      </button>
    </div>
  </div>
</div>